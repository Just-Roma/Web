<!DOCTYPE html>
<html style="background-color:black;">
<script id="worker" type="javascript/worker">

	class Matrix{

		constructor(width, height) {
			this.width = width;
			this.height = height;
			this.entries = Array.from({length: width*height*4}, () => 0); // Each entry stores RGB and a counter.
		}
		
		get(x, y) {return this.entries[y*this.width*4 + x*4+3];}	

		set1(x, y, value){
			this.entries[y*this.width*4 + x*4] = value[0];
			this.entries[y*this.width*4 + x*4+1] = value[1];
			this.entries[y*this.width*4 + x*4+2] = value[2];
		}
		set2(x, y, value){
			this.entries[y*this.width*4 + x*4]   = Math.round((this.entries[y*this.width*4 + x*4] + value[0])/2);
			this.entries[y*this.width*4 + x*4+1] = Math.round((this.entries[y*this.width*4 + x*4+1] + value[1])/2);
			this.entries[y*this.width*4 + x*4+2] = Math.round((this.entries[y*this.width*4 + x*4+2] + value[2])/2);
		}
		inc(x, y) {this.entries[y*this.width*4 + x*4+3]++;}
	}

	let Functions = {

	'Linear': function(){
		let out = function(x,y){return [x, y];};
		
		return out;
	},

	'Sinusoidal': function(){
		let out = function(x,y){return [Math.sin(x), Math.sin(y)];};
		
		return out;
	},

	'Spherical': function(){
		let out = function(x,y){return [x/(x**2 + y**2), y/(x**2 + y**2)];};
		
		return out;
	},

	'Swirl': function(){
		let out = function(x,y){
			let rSquare = x**2 + y**2;
			return [x*Math.sin(rSquare) - y*Math.cos(rSquare), x*Math.cos(rSquare) + y*Math.sin(rSquare)];
		}
		
		return out;
	},

	'Horseshoe': function(){
		let out = function(x,y){return [(x-y)*(x+y)/Math.sqrt(x**2 + y**2), 2*x*y/Math.sqrt(x**2 + y**2)];};
		
		return out;
	},

	'Polar': function(){
		let out = function(x,y){return [Math.atan(x/y)/Math.PI, Math.sqrt(x**2 + y**2)-1];};
		
		return out;
	},

	'Handkerchief': function(){
		let out = function(x,y){
			let r = Math.sqrt(x**2 + y**2);
			let Teta = Math.atan(x/y);
			return [r*Math.sin(Teta+r), r*Math.cos(Teta-r)];
		}
		
		return out;
	},

	'Heart': function(){
		let out = function(x,y){
			let r = Math.sqrt(x**2 + y**2);
			let Teta = Math.atan(x/y);
			return [r*Math.sin(Teta*r), -r*Math.cos(Teta*r)];
		}
		
		return out;
	},

	'Disc': function(){
		let out = function(x,y){
			let r = Math.PI*Math.sqrt(x**2 + y**2);
			let Teta = Math.atan2(x,y)/Math.PI;
			return [Teta*Math.sin(r), Teta*Math.cos(r)];
		}
		
		return out;
	},
	//...............................
	'Bent': function(){
		let out = function(x,y){
			if (x >= 0 && y >= 0) return [x,y];
			else if (x < 0 && y >= 0) return [2*x,y];
			else if (x >= 0 && y < 0) return [x,y/2];
			else return [2*x,y/2];
		};
		
		return out;
	}}

	let i = 0;
	for (let value in Functions){
		Functions[i] = Functions[value];
		i++;
	}
	let len=25;
	let IFS = Array.from({length:len});
	for (let i = 0; i < len; i++){
		//IFS[i] = Functions[Math.round(Math.random()*9)]();
		IFS[i] = Functions[7]();
	}
let yy=Functions[5]();
	self.onmessage = function(message){
		let width  = message.data[0];
		let height = message.data[1];
		let coef = message.data[2][0];
		let rgb = message.data[2][1];
		let fractalFlame = new Matrix(width, height);
		let BiPoint, cur_dot, chosenF, Ran;

		for (let i = 0; i < 5000000; i++){
			BiPoint = [Math.random()*2-1, Math.random()*2-1];
			
			for (let j = -20; j < 0; j++){
			Ran=Math.round(Math.random()*15);
				//chosenF = IFS[Math.round(Math.random()*(len-1))];
				BiPoint = yy(coef[Ran][0]*BiPoint[0] + coef[Ran][1]*BiPoint[1] + coef[Ran][2], coef[Ran][3]*BiPoint[0]+ coef[Ran][4]*BiPoint[1] + coef[Ran][5]);
			}

			cur_dot = [width-Math.floor(((1-BiPoint[0])/2)*width), height-Math.floor(((1-BiPoint[1])/2)*height)];
			
			if (cur_dot[0] >= 0 && cur_dot[0] < width && cur_dot[1] >= 0 && cur_dot[1] < height){
				
				if(fractalFlame.get(cur_dot[0],cur_dot[1])){
					fractalFlame.set1(cur_dot[0],cur_dot[1], rgb[Ran]);
				}
				else fractalFlame.set2(cur_dot[0],cur_dot[1], rgb[Ran]);
				fractalFlame.inc(cur_dot[0],cur_dot[1]);
			}
		}
		self.postMessage(fractalFlame);
	};

</script>
<script type="text/javascript" src="C:\Users\df\Desktop\flamefractal.js" defer></script>
<body><canvas id="Canvas"></canvas>
</body>
</html>
